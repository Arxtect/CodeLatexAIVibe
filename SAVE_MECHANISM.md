# 新的保存机制说明

## 概述

LaTeX IDE 现在使用基于 Yjs 的实时同步机制，替代了传统的手动保存模式。

## 工作原理

### 1. 实时同步
- **自动同步**：编辑器中的所有更改都会自动实时同步到 Yjs 项目文档
- **无需手动保存**：内容变化会立即保存到 IndexedDB 中
- **多文件管理**：所有打开的文件都在同一个项目文档中管理

### 2. 版本快照
- **手动快照**：点击"💾 快照"按钮或按 Ctrl+S 创建版本快照
- **自动快照**：可配置自动创建快照的时间间隔
- **智能检测**：只有在内容真正发生变化时才创建快照

### 3. 数据持久化
- **主要存储**：Yjs 项目文档存储在 IndexedDB 中
- **版本历史**：快照元数据存储在 localStorage 中
- **实时备份**：每次编辑都会自动备份

## 用户体验改进

### 1. 无缝编辑
- ✅ 无需担心忘记保存
- ✅ 关闭标签时无需确认
- ✅ 实时显示同步状态
- ✅ 支持撤销/重做操作

### 2. 版本管理
- ✅ 项目级版本控制
- ✅ 多文件同时管理
- ✅ 版本历史侧边栏
- ✅ 快照比较功能

### 3. 数据安全
- ✅ 自动备份机制
- ✅ 版本历史保护
- ✅ 意外关闭恢复
- ✅ 数据完整性检查

## 快捷键变化

| 操作 | 快捷键 | 新功能 |
|------|--------|--------|
| 创建快照 | Ctrl+S | 创建版本快照（内容已实时同步） |
| 撤销 | Ctrl+Z | 基于 Yjs 的撤销操作 |
| 重做 | Ctrl+Y | 基于 Yjs 的重做操作 |
| 版本历史 | Ctrl+Shift+V | 打开版本历史侧边栏 |

## 技术架构

### 1. 数据流
```
编辑器 → Yjs 绑定 → 项目文档 → IndexedDB
                ↓
            版本快照 → localStorage
```

### 2. 存储层次
- **实时层**：Yjs 项目文档（IndexedDB）
- **版本层**：快照历史（localStorage）
- **缓存层**：标签页内存缓存

### 3. 同步机制
- **Monaco Binding**：编辑器与 Yjs 的双向绑定
- **自动持久化**：Yjs 自动保存到 IndexedDB
- **版本检测**：智能检测内容变化

## 迁移说明

### 从旧版本升级
1. 旧的文件系统数据会在首次打开时自动迁移到 Yjs
2. 版本历史会保持兼容
3. 用户习惯需要适应新的保存概念

### 数据兼容性
- ✅ 支持现有项目结构
- ✅ 保持文件路径不变
- ✅ 版本历史向后兼容
- ✅ 设置配置保持不变

## 故障排除

### 常见问题
1. **内容丢失**：检查版本历史，可恢复到任意快照
2. **同步异常**：重新打开文件会自动重新绑定
3. **性能问题**：大文件会自动优化同步频率

### 调试工具
- `window.testAutoComplete()`：测试自动补全
- `window.ide.versionManager.getProjectStatus()`：查看项目状态
- `window.ide.versionManager.getProjectSnapshots()`：查看快照列表

## 未来规划

### 1. 协作功能
- 多用户实时协作
- 冲突解决机制
- 权限管理系统

### 2. 云同步
- 云端备份
- 跨设备同步
- 离线工作支持

### 3. 性能优化
- 增量同步
- 压缩存储
- 智能缓存 