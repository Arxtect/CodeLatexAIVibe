# 版本管理系统使用指南

## 概述

本 LaTeX IDE 集成了基于 Yjs 的强大版本管理系统，提供实时协作编辑、版本快照、差异比较等功能。

## 核心特性

### 🔄 实时版本控制
- **自动持久化**: 使用 IndexedDB 自动保存文档状态
- **CRDT 技术**: 基于 Yjs 的冲突自由复制数据类型
- **Monaco 集成**: 与编辑器深度集成，支持实时同步

### 📸 快照管理
- **手动快照**: 随时创建带描述的版本快照
- **自动快照**: 可配置定时自动创建快照
- **快照浏览**: 查看所有历史版本和详细信息

### 🔍 版本比较
- **差异对比**: 可视化显示两个版本间的差异
- **行级比较**: 精确到行的增删改对比
- **统计信息**: 显示添加、删除、修改的行数统计

## 使用方法

### 1. 打开版本管理

#### 方式一：工具栏按钮
点击工具栏中的 **"版本管理"** 按钮

#### 方式二：快捷键
使用快捷键 `Ctrl+Shift+V` (Windows/Linux) 或 `Cmd+Shift+V` (Mac)

#### 方式三：右键菜单
在编辑器中右键选择 **"版本管理"**

### 2. 创建快照

#### 手动创建
1. 点击版本管理界面中的 **"创建快照"** 按钮
2. 输入快照描述（可选）
3. 确认创建

#### 快捷键创建
使用快捷键 `Ctrl+Shift+S` 快速创建快照

#### 自动创建
1. 点击 **"自动快照"** 按钮
2. 设置自动快照间隔（分钟）
3. 系统将在指定间隔自动创建快照

### 3. 版本历史浏览

版本管理界面显示：
- **版本号**: 按创建顺序编号 (v1, v2, v3...)
- **创建时间**: 相对时间和绝对时间
- **描述信息**: 用户输入的快照描述
- **文件大小**: 快照内容的字符数
- **最新标记**: 标识最新版本

### 4. 版本操作

#### 恢复版本
1. 在版本列表中找到目标版本
2. 点击 **"恢复"** 按钮
3. 确认恢复操作

#### 查看版本
1. 点击版本的 **"查看"** 按钮
2. 在弹出窗口中查看完整内容

#### 删除版本
1. 点击版本的 **"删除"** 按钮
2. 确认删除操作（不可撤销）

### 5. 版本比较

#### 选择版本
1. 勾选要比较的两个版本（最多选择2个）
2. **"比较版本"** 按钮会显示选择状态

#### 查看差异
1. 点击 **"比较版本"** 按钮
2. 在比较窗口中查看：
   - 版本信息对比
   - 变更统计（添加/删除行数）
   - 逐行差异显示

#### 差异显示说明
- **绿色背景**: 新增的行
- **红色背景**: 删除的行
- **白色背景**: 未修改的行
- **行号**: 显示在原文件中的位置
- **前缀**: `+` 表示新增，`-` 表示删除

### 6. 导出版本历史

1. 点击 **"导出历史"** 按钮
2. 系统会下载包含完整版本历史的 JSON 文件
3. 文件包含：
   - 文件路径信息
   - 导出时间戳
   - 所有版本快照数据

## 技术架构

### Yjs 集成
```javascript
// 文档创建
const doc = new Y.Doc();
const yText = doc.getText('content');

// Monaco 绑定
const binding = new MonacoBinding(yText, editor.getModel());

// 持久化
const provider = new IndexeddbPersistence(filePath, doc);
```

### 数据结构
```javascript
// 快照数据结构
{
    id: 'snapshot_timestamp_random',
    filePath: '/path/to/file.tex',
    timestamp: '2024-01-01T12:00:00.000Z',
    description: '用户描述',
    content: '文件内容',
    state: Uint8Array, // Yjs 状态数据
    version: 1
}
```

### 存储机制
- **IndexedDB**: Yjs 文档状态的持久化存储
- **localStorage**: 快照元数据的存储
- **内存缓存**: 活跃文档的实时状态

## 最佳实践

### 1. 快照策略
- **重要节点**: 在完成重要功能或章节时创建快照
- **实验前**: 在尝试大幅修改前创建快照
- **定期备份**: 设置合理的自动快照间隔

### 2. 描述规范
- 使用清晰的描述说明快照内容
- 包含版本特性或修改要点
- 便于后续查找和识别

### 3. 版本管理
- 定期清理不需要的历史版本
- 保留关键里程碑版本
- 导出重要版本历史作为备份

### 4. 性能优化
- 避免创建过多快照影响性能
- 大文件建议适当控制快照频率
- 定期清理浏览器存储空间

## 故障排除

### 常见问题

#### 1. 快照创建失败
- **原因**: 存储空间不足或权限问题
- **解决**: 清理浏览器存储，检查权限设置

#### 2. 版本恢复失败
- **原因**: 快照数据损坏或不存在
- **解决**: 尝试恢复到其他版本，重新创建快照

#### 3. 差异显示异常
- **原因**: 文本编码问题或数据格式错误
- **解决**: 检查文件编码，重新创建快照

#### 4. 自动快照不工作
- **原因**: 定时器被清除或页面失去焦点
- **解决**: 重新设置自动快照间隔

### 数据恢复

#### 导出数据
```javascript
// 手动导出版本历史
const history = versionManager.getDocumentHistory(filePath);
const data = JSON.stringify(history, null, 2);
```

#### 清理数据
```javascript
// 清理特定文件的版本数据
versionManager.cleanupFile(filePath);

// 清理所有数据
localStorage.removeItem('yjs-snapshots');
```

## 高级功能

### 1. 协作编辑
虽然当前版本主要用于单用户版本管理，但 Yjs 架构支持未来扩展为多用户协作：

```javascript
// 未来可添加 WebSocket 提供者实现协作
import { WebsocketProvider } from 'y-websocket';
const wsProvider = new WebsocketProvider('ws://localhost:1234', 'room-name', doc);
```

### 2. 冲突解决
Yjs 的 CRDT 特性确保：
- 自动解决编辑冲突
- 保持操作的因果关系
- 支持离线编辑同步

### 3. 扩展集成
版本管理系统可与其他功能集成：
- Git 版本控制
- 云端同步
- 团队协作
- 审阅工作流

## 总结

基于 Yjs 的版本管理系统为 LaTeX IDE 提供了强大的版本控制能力，支持：

✅ **实时版本控制** - 自动保存和同步  
✅ **快照管理** - 手动和自动快照创建  
✅ **版本比较** - 可视化差异对比  
✅ **历史浏览** - 完整的版本历史记录  
✅ **数据持久化** - 可靠的本地存储  
✅ **性能优化** - 高效的 CRDT 算法  

通过合理使用这些功能，可以大大提高文档编辑的安全性和效率，为学术写作和协作提供强有力的支持。 