# Undo/Redo 功能使用指南

## 概述

LaTeX IDE 现在支持强大的撤销/重做功能，基于 Yjs UndoManager 实现，提供跨文件的操作历史管理。

## 功能特性

### 🔄 **智能撤销/重做**
- **跨文件支持**：可以撤销/重做不同文件中的操作
- **实时同步**：与 Yjs 实时同步机制完美集成
- **操作粒度**：支持字符级别的精细撤销/重做
- **历史保持**：切换文件时保持操作历史

### 🎯 **使用方式**

#### 1. 快捷键操作
- **撤销**：`Ctrl+Z` (Windows/Linux) 或 `Cmd+Z` (Mac)
- **重做**：`Ctrl+Y` (Windows/Linux) 或 `Cmd+Y` (Mac)

#### 2. 工具栏按钮
- **撤销按钮**：`↶ 撤销` - 点击撤销最近的操作
- **重做按钮**：`↷ 重做` - 点击重做已撤销的操作

#### 3. 按钮状态指示
- **启用状态**：按钮正常显示，可以点击
- **禁用状态**：按钮变灰，无法点击
- **工具提示**：悬停显示快捷键提示

## 技术实现

### 🏗️ **架构设计**

```
编辑器操作 → Yjs 文档变更 → UndoManager 记录
     ↓              ↓              ↓
  实时同步    →   IndexedDB   →   操作历史
```

### 🔧 **核心组件**

1. **Yjs UndoManager**
   - 管理所有文件的操作历史
   - 支持动态添加新文件到跟踪范围
   - 提供 `undo()` 和 `redo()` 方法

2. **Monaco Editor 绑定**
   - 通过 `MonacoBinding` 连接编辑器和 Yjs
   - 自动捕获编辑操作
   - 实时更新操作历史

3. **UI 状态管理**
   - 实时更新按钮启用/禁用状态
   - 提供操作反馈信息
   - 响应快捷键操作

### 📊 **数据流程**

1. **操作记录**
   ```
   用户编辑 → Monaco Editor → Yjs 文档 → UndoManager
   ```

2. **撤销操作**
   ```
   用户触发 → UndoManager.undo() → Yjs 文档回滚 → 编辑器更新
   ```

3. **重做操作**
   ```
   用户触发 → UndoManager.redo() → Yjs 文档前进 → 编辑器更新
   ```

## 使用场景

### 📝 **日常编辑**
- 撤销错误的文本输入
- 恢复意外删除的内容
- 重做已撤销的有用操作
- 在多个文件间切换时保持历史

### 🔍 **调试和实验**
- 尝试不同的代码实现
- 快速回滚到工作状态
- 比较不同版本的效果
- 安全地进行大胆修改

### 📚 **协作编辑**
- 撤销他人的错误操作
- 恢复被覆盖的内容
- 维护文档的一致性
- 处理编辑冲突

## 最佳实践

### ✅ **推荐做法**

1. **频繁保存快照**
   - 在重要修改前创建快照
   - 使用 `Ctrl+S` 创建版本快照
   - 定期备份重要节点

2. **合理使用撤销**
   - 小步骤撤销，避免大范围回滚
   - 结合快照功能使用
   - 注意跨文件操作的影响

3. **监控操作历史**
   - 观察按钮状态变化
   - 注意状态栏反馈信息
   - 使用测试函数检查状态

### ⚠️ **注意事项**

1. **操作粒度**
   - 撤销是基于 Yjs 操作的，不是基于用户动作
   - 一次输入可能对应多个撤销步骤
   - 复制粘贴是一个原子操作

2. **跨文件影响**
   - 撤销可能影响其他文件的内容
   - 注意文件间的依赖关系
   - 使用快照功能作为安全网

3. **性能考虑**
   - 大文件的撤销可能较慢
   - 历史记录会占用内存
   - 定期清理不需要的历史

## 调试和测试

### 🔧 **调试工具**

在浏览器控制台中使用以下命令：

```javascript
// 测试 undo/redo 功能状态
window.testUndoRedo()

// 查看版本管理器状态
window.ide.versionManager.getProjectStatus()

// 手动触发撤销/重做
window.ide.undo()
window.ide.redo()

// 检查 UndoManager 状态
window.ide.versionManager.canUndo()
window.ide.versionManager.canRedo()
```

### 📋 **测试步骤**

1. **基本功能测试**
   ```
   1. 打开文件并输入一些文本
   2. 按 Ctrl+Z 撤销输入
   3. 按 Ctrl+Y 重做输入
   4. 观察按钮状态变化
   ```

2. **跨文件测试**
   ```
   1. 打开多个文件
   2. 在不同文件中进行编辑
   3. 切换文件后尝试撤销
   4. 验证操作历史保持
   ```

3. **边界情况测试**
   ```
   1. 在空文件中尝试撤销
   2. 连续撤销到历史开始
   3. 连续重做到历史结束
   4. 检查按钮禁用状态
   ```

## 故障排除

### 🐛 **常见问题**

1. **按钮始终禁用**
   - 检查版本管理器是否初始化
   - 确认文件已正确绑定
   - 运行 `window.testUndoRedo()` 诊断

2. **撤销不生效**
   - 确认有可撤销的操作
   - 检查 UndoManager 状态
   - 重新绑定文件到编辑器

3. **跨文件撤销异常**
   - 确认所有文件都已绑定
   - 检查文件切换逻辑
   - 验证 UndoManager 跟踪范围

### 🔧 **解决方案**

1. **重新初始化**
   ```javascript
   // 重新绑定当前文件
   window.ide.versionManager.bindFileToEditor(
       window.ide.currentFile, 
       window.ide.editor
   )
   ```

2. **状态重置**
   ```javascript
   // 刷新页面重新初始化
   location.reload()
   ```

3. **手动修复**
   ```javascript
   // 手动更新按钮状态
   window.ide.updateUndoRedoButtons()
   ```

## 未来增强

### 🚀 **计划功能**

1. **可视化历史**
   - 操作历史时间线
   - 分支历史管理
   - 历史操作预览

2. **智能撤销**
   - 语义级别撤销
   - 批量操作撤销
   - 选择性撤销

3. **协作增强**
   - 多用户撤销隔离
   - 冲突解决机制
   - 权限控制

### 💡 **优化方向**

1. **性能优化**
   - 历史压缩算法
   - 增量存储
   - 懒加载历史

2. **用户体验**
   - 撤销预览
   - 操作提示
   - 快捷操作

3. **稳定性**
   - 错误恢复
   - 状态一致性
   - 数据完整性 