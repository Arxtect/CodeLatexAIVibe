<!DOCTYPE html>
<html>
<head>
    <title>UndoManager æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        button { margin: 10px; padding: 10px 20px; }
        button:disabled { background: #ccc; color: #666; cursor: not-allowed; }
        .log { background: #f0f0f0; padding: 10px; margin: 10px 0; height: 300px; overflow-y: auto; }
        #editor { width: 100%; height: 200px; border: 1px solid #ccc; padding: 10px; }
    </style>
</head>
<body>
    <h1>UndoManager ç‹¬ç«‹æµ‹è¯•</h1>
    
    <div>
        <button id="createBtn" onclick="createUndoManager()">åˆ›å»º UndoManager</button>
        <button id="undoBtn" onclick="testUndo()" disabled>æ’¤é”€</button>
        <button id="redoBtn" onclick="testRedo()" disabled>é‡åš</button>
        <button onclick="addText()">æ·»åŠ æ–‡æœ¬</button>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>
    
    <textarea id="editor" placeholder="åœ¨è¿™é‡Œè¾“å…¥æ–‡æœ¬..."></textarea>
    
    <div class="log" id="log"></div>
    
    <script type="module">
        import * as Y from 'yjs';
        
        let doc = null;
        let yText = null;
        let undoManager = null;
        
        window.Y = Y; // æš´éœ²åˆ°å…¨å±€
        
        function log(message) {
            const logDiv = document.getElementById('log');
            logDiv.innerHTML += new Date().toLocaleTimeString() + ': ' + message + '<br>';
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        window.createUndoManager = function() {
            try {
                log('å¼€å§‹åˆ›å»º UndoManager...');
                
                // åˆ›å»º Y.Doc
                doc = new Y.Doc();
                log('âœ… Y.Doc åˆ›å»ºæˆåŠŸ');
                
                // åˆ›å»º Y.Text
                yText = doc.getText('content');
                log('âœ… Y.Text åˆ›å»ºæˆåŠŸ');
                
                // åˆ›å»º UndoManager
                undoManager = new Y.UndoManager(yText);
                log('âœ… UndoManager åˆ›å»ºæˆåŠŸ');
                
                // ç›‘å¬ UndoManager äº‹ä»¶
                undoManager.on('stack-item-added', () => {
                    log('ğŸ“ UndoManager: stack-item-added');
                    updateButtons();
                });
                
                undoManager.on('stack-item-popped', () => {
                    log('ğŸ“¤ UndoManager: stack-item-popped');
                    updateButtons();
                });
                
                // ç›‘å¬ Y.Text å˜åŒ–
                yText.observe((event) => {
                    log(`ğŸ“„ Y.Text å˜åŒ–: ${event.changes.delta.map(d => d.insert || d.delete || d.retain).join('')}`);
                    updateEditor();
                });
                
                // ç»‘å®šç¼–è¾‘å™¨
                const editor = document.getElementById('editor');
                editor.addEventListener('input', () => {
                    const content = editor.value;
                    const currentContent = yText.toString();
                    if (content !== currentContent) {
                        yText.delete(0, yText.length);
                        yText.insert(0, content);
                    }
                });
                
                updateButtons();
                log('ğŸ‰ UndoManager åˆå§‹åŒ–å®Œæˆ');
                
            } catch (error) {
                log('âŒ åˆ›å»º UndoManager å¤±è´¥: ' + error.message);
                console.error(error);
            }
        };
        
        window.testUndo = function() {
            if (undoManager && undoManager.canUndo()) {
                log('â¬…ï¸ æ‰§è¡Œæ’¤é”€æ“ä½œ');
                undoManager.undo();
            } else {
                log('âŒ æ— æ³•æ’¤é”€');
            }
        };
        
        window.testRedo = function() {
            if (undoManager && undoManager.canRedo()) {
                log('â¡ï¸ æ‰§è¡Œé‡åšæ“ä½œ');
                undoManager.redo();
            } else {
                log('âŒ æ— æ³•é‡åš');
            }
        };
        
        window.addText = function() {
            if (yText) {
                const text = `æ–‡æœ¬${Date.now()} `;
                yText.insert(yText.length, text);
                log(`â• æ·»åŠ æ–‡æœ¬: "${text}"`);
            } else {
                log('âŒ Y.Text æœªåˆå§‹åŒ–');
            }
        };
        
        function updateButtons() {
            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');
            
            if (undoManager) {
                undoBtn.disabled = !undoManager.canUndo();
                redoBtn.disabled = !undoManager.canRedo();
                
                log(`ğŸ”„ æŒ‰é’®çŠ¶æ€æ›´æ–°: æ’¤é”€=${!undoBtn.disabled}, é‡åš=${!redoBtn.disabled}`);
            } else {
                undoBtn.disabled = true;
                redoBtn.disabled = true;
            }
        }
        
        function updateEditor() {
            if (yText) {
                const editor = document.getElementById('editor');
                const content = yText.toString();
                if (editor.value !== content) {
                    editor.value = content;
                }
            }
        }
        
        window.clearLog = function() {
            document.getElementById('log').innerHTML = '';
        };
        
        // åˆå§‹åŒ–
        log('UndoManager æµ‹è¯•é¡µé¢å·²åŠ è½½');
        log('Y.js ç‰ˆæœ¬: ' + (Y.version || 'æœªçŸ¥'));
        log('ç‚¹å‡»"åˆ›å»º UndoManager"å¼€å§‹æµ‹è¯•');
    </script>
</body>
</html> 